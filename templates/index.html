<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Кафе Камера</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.8.0/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>

</head>
<body style="background-image: url('{{ url_for('static', filename='images/background.png') }}'); background-size: cover;">
 <!-- Использовано cover для заполнения всего фона -->
    <nav class="navbar navbar-light bg-light shadow p-3">
        <div class="container" style="width: fit-content;"> <!-- Убран класс mx-4 для унификации стиля -->
            <img src="{{ url_for('static', filename='images/logo2.png') }}" alt="Логотип">
            <span class="ms-5">Статистика посещений</span>
        </div>
    </nav>
    <h4 class="m-4">Статистика посещений</h4>
    <div class="d-flex justify-content-center mt-3">
        <div class="container" style="width: fit-content">
            <input type="date" class="shadow rounded" >
            <div id="graph-container">
                <canvas id="canvas" width="640" height="480"></canvas>
            </div>
        </div>
    </div>
    <h4 class="m-4">Видеопоток кафе</h4>
    <div class="d-flex justify-content-center mt-3">
        <div>
            <!-- Использование img для видеопотока -->
            <img src="{{ url_for('video_feed') }}" alt="Видеопоток" style="max-width: 100%; height: auto;"><!-- Добавлены атрибуты для контроля размера -->
        </div>
    </div>
    <table id="visitorsTable">
        <thead>
            <tr>
                <th>Время</th>
                <th>Количество посетителей</th>
            </tr>
        </thead>
        <tbody>
            <!-- Здесь будут строки таблицы, добавленные динамически -->
        </tbody>
    </table>

        <script>
            $(document).ready(function() {
                $.getJSON('/data/last_24_hours', function(data) {
                    var tableBody = $('#visitorsTable tbody');
                    tableBody.empty(); // Очищаем текущие строки таблицы
                    data.forEach(function(record) {
                        var row = `<tr>
                                       <td>${record.timestamp}</td>
                                       <td>${record.count}</td>
                                   </tr>`;
                        tableBody.append(row);
                    });
                });
            });
        </script>
        <script>
        $(document).ready(function() {
            // Отображение графика
            var ctx = document.getElementById("canvas").getContext("2d");
            var chart = new Chart(ctx, {
                type: "line",
                data: {
                    labels: [],
                    datasets: [{
                        label: "Люди",
                        data: []
                    }]
                },
                options: {
                    scales: {
                        yAxes: [{
                            ticks: {
                                min: 0
                            }
                        }]
                    }
                }
            });

            // Обновление графика
            setInterval(function() {
                $.ajax({
                    url: "/data",
                    success: function(data) {
                        // Преобразование временных меток в человеческий вид
                        var formattedLabels = data.timestamps.map(function(timestamp) {
                            return moment.unix(timestamp).format("HH:mm:ss"); // Форматируем как часы:минуты:секунды
                        });
                        chart.data.labels = formattedLabels;
                        chart.data.datasets[0].data = data.counts;
                        chart.update();
                    }
                });
            }, 1000);

            // Запись видео
            $("#record-button").click(function() {
                $.ajax({
                    url: "/record",
                    success: function() {
                        alert("Запись видео начата!");
                    }
                });
            });

            // Подсчет людей
            $("#count-button").click(function() {
                $.ajax({
                    url: "/count",
                    success: function() {
                        alert("Подсчет людей начат!");
                    }
                });
            });
        });
        </script>
</body>
</html>
